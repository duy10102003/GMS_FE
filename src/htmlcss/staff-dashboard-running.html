<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GaragePro - Dashboard Nh√¢n vi√™n</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css}"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/staff/staff-dashboard.css}"/>
</head>
<body>
<!-- Sidebar (gi·ªØ nguy√™n) -->
<aside class="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <a href="http://localhost:8081/home">
                <span class="orange">Garage</span><span class="dark">Pro</span>
            </a>
        </div>
    </div>

    <div class="user-profile">
        <img src="https://ui-avatars.com/api/?name=Tr·∫ßn+Th·ªã+B&background=FF7A00&color=fff" alt="Avatar">
        <div class="user-info">
            <h6>Tr·∫ßn Th·ªã B</h6>
            <small>Nh√¢n vi√™n l·ªÖ t√¢n</small>
        </div>
    </div>

    <ul class="nav-menu">
        <li><a href="/dashboard-staff" class="nav-link active"><i class="fas fa-gauge"></i> Dashboard</a></li>
        <li><a href="/payment" class="nav-link"><i class="fas fa-credit-card"></i> Thanh to√°n</a></li>
        <li><a href="/inventory-alert" class="nav-link"><i class="fas fa-exclamation-triangle"></i> C·∫£nh b√°o kho</a></li>
    </ul>

    <button class="logout-btn" type="button" onclick="logout(event)">
        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
    </button>
</aside>

<!-- Header (gi·ªØ nguy√™n) -->
<header class="main-header d-flex align-items-center justify-content-between">
    <h1 class="page-title">Dashboard Nh√¢n vi√™n üìã</h1>

    <div class="dropdown position-relative">
        <button class="notification-btn" id="notifDropdown" data-bs-toggle="dropdown">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">4</span>
        </button>

        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-0" style="min-width: 320px; border-radius: 16px;">
            <li class="dropdown-header py-3 px-3 border-bottom bg-light fw-semibold">
                Th√¥ng b√°o h√¥m nay
            </li>
            <li><a href="#" class="dropdown-item py-3">
                <div class="d-flex align-items-start gap-3">
                    <div style="width:40px;height:40px;background:rgba(247,183,49,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#f7b731;">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div>
                        <strong>Phi·∫øu m·ªõi #SV009</strong>
                        <div class="small text-muted">Kh√°ch h√†ng: L√™ VƒÉn C</div>
                        <div class="small text-muted">V·ª´a xong</div>
                    </div>
                </div>
            </a></li>
        </ul>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="d-flex justify-content-end align-items-center mb-3">
        <nav class="breadcrumb mb-0">
            <span><a href="#" class="text-primary text-decoration-none">Staff</a></span>
            <span class="mx-2 text-muted">/</span>
            <span class="text-muted">T·ªïng quan</span>
        </nav>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid fade-in">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(84, 160, 255, 0.1); color: var(--info);">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <h6>Phi·∫øu ch·ªù x·ª≠ l√Ω</h6>
            <div class="value" id="pendingCount">0</div>
            <div class="change negative"><i class="fas fa-arrow-up"></i> <span id="pendingChange">0</span> h√¥m nay</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(16, 172, 132, 0.1); color: var(--success);">
                <i class="fas fa-check-circle"></i>
            </div>
            <h6>Ho√†n th√†nh h√¥m nay</h6>
            <div class="value" id="completedCount">0</div>
            <div class="change positive"><i class="fas fa-arrow-up"></i> <span id="completedChange">0</span> so v·ªõi h√¥m qua</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(247, 183, 49, 0.1); color: var(--warning);">
                <i class="fas fa-box"></i>
            </div>
            <h6>C·∫£nh b√°o ph·ª• t√πng</h6>
            <div class="value">3</div>
            <div class="change negative"><i class="fas fa-exclamation-triangle"></i> C·∫ßn nh·∫≠p kho</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(255, 122, 0, 0.1); color: var(--primary);">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <h6>Doanh thu h√¥m nay</h6>
            <div class="value" id="revenueToday">0</div>
            <div class="change positive"><i class="fas fa-chart-line"></i> +12%</div>
        </div>
    </div>

    <!-- Service Management Card -->
    <div class="content-card fade-in" id="serviceCard">
        <div class="content-card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
            <h5><i class="fas fa-clipboard-list me-2"></i>Qu·∫£n l√Ω phi·∫øu d·ªãch v·ª•</h5>
            <button class="btn btn-primary" onclick="openCreateTicket()">
                <i class="fas fa-plus"></i> T·∫°o phi·∫øu m·ªõi
            </button>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="T√¨m theo m√£ phi·∫øu, kh√°ch h√†ng, bi·ªÉn s·ªë..." id="searchInput" oninput="searchTickets()">
            </div>
            <select class="filter-select" id="statusFilter" onchange="filterByStatus()">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="New">M·ªõi</option>
                <option value="Assigned">ƒê√£ ph√¢n c√¥ng</option>
                <option value="In Progress">ƒêang x·ª≠ l√Ω</option>
                <option value="Completed">Ho√†n t·∫•t</option>
                <option value="Paid">ƒê√£ thanh to√°n</option>
                <option value="Cancelled">ƒê√£ h·ªßy</option>
            </select>
        </div>
        <p>T·ªïng s·ªë phi·∫øu: <strong id="totalTickets">0</strong></p>

        <!-- Table -->
        <div style="overflow-x: auto;">
            <table class="custom-table">
                <thead>
                <tr>
                    <th>M√£ phi·∫øu</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>Bi·ªÉn s·ªë</th>
                    <th>D·ªãch v·ª•</th>
                    <th>Th·ª£ ph·ª• tr√°ch</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-center">H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody id="serviceTableBody">
                <!-- Data will be rendered by JavaScript -->
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                        <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination" id="pagination"></ul>
        </nav>
    </div>

    <!-- Modal: View Ticket Detail -->
    <div class="modal fade" id="viewTicketModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-eye me-2 text-primary"></i>Chi ti·∫øt phi·∫øu d·ªãch v·ª•</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="ticketDetailContent">
                    <!-- N·ªôi dung chi ti·∫øt render b·∫±ng JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Y√™u c·∫ßu b·ªï sung d·ªãch v·ª• -->
    <div class="modal fade" id="addServiceRequestModal" tabindex="-1">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4 p-3">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">
                        <i class="fas fa-plus-circle text-primary me-2"></i>Y√™u c·∫ßu b·ªï sung d·ªãch v·ª•
                    </h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body mt-2">
                    <form id="addServiceRequestForm" onsubmit="submitAddServiceRequest(event)">
                        <input type="hidden" id="amendTicketId">
                        <div class="mb-3">
                            <label class="form-label">D·ªãch v·ª• mu·ªën th√™m *</label>
                            <select id="amendServiceSelect" class="form-select" required>
                                <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">L√Ω do ƒë·ªÅ xu·∫•t</label>
                            <textarea id="amendReason" class="form-control" rows="3" placeholder="V√≠ d·ª•: Kh√°ch mu·ªën thay d·∫ßu th√™m..."></textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-light border me-2" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>G·ª≠i y√™u c·∫ßu</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Create Ticket -->
    <div class="modal fade" id="createTicketModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content p-4 shadow-lg border-0 rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">
                        <i class="fas fa-file-medical me-2 text-primary"></i>
                        T·∫°o phi·∫øu d·ªãch v·ª• m·ªõi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body mt-2">
                    <form id="createTicketForm" onsubmit="handleCreateTicket(event)">
                        <div class="row g-3">

                            <!-- ========== TH√îNG TIN KH√ÅCH H√ÄNG ========== -->
                            <div class="col-12">
                                <h6 class="section-title"><i class="fas fa-user me-2"></i>Th√¥ng tin kh√°ch h√†ng</h6>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">H·ªç t√™n *</label>
                                <input type="text" class="form-control" id="customerName" required placeholder="Nguy·ªÖn VƒÉn A">
                            </div>

                            <!--                        <div class="col-md-4">-->
                            <!--                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>-->
                            <!--                            <input type="tel" class="form-control" id="customerPhone" required placeholder="0912345678">-->
                            <!--                        </div>-->

                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="customerEmail" placeholder="example@email.com">
                            </div>

                            <!-- ========== TH√îNG TIN XE ========== -->
                            <div class="col-12 mt-4">
                                <h6 class="section-title"><i class="fas fa-car me-2"></i>Th√¥ng tin xe</h6>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Bi·ªÉn s·ªë *</label>
                                <input type="text" class="form-control" id="plateNumber" required placeholder="30H-12345"
                                       onblur="fetchVehicleInfo(this.value)">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">H√£ng xe (Brand)</label>
                                <select class="form-select" id="carBrand" required>
                                    <option value="">-- Ch·ªçn h√£ng --</option>
                                    <option value="Toyota">Toyota</option>
                                    <option value="Mazda">Mazda</option>
                                    <option value="Hyundai">Hyundai</option>
                                    <option value="Honda">Honda</option>
                                    <option value="Kia">Kia</option>
                                    <option value="VinFast">VinFast</option>
                                    <option value="Mitsubishi">Mitsubishi</option>
                                    <option value="Ford">Ford</option>
                                </select>
                            </div>

                            <div class="col-md-3 position-relative">
                                <label class="form-label">Model xe</label>
                                <input type="text" class="form-control" id="carModelInput" placeholder="Nh·∫≠p model xe..." autocomplete="off" required>
                                <ul id="modelSuggestions"
                                    class="list-group position-absolute w-100 shadow"
                                    style="z-index:1000; display:none; max-height:180px; overflow-y:auto;"></ul>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">NƒÉm s·∫£n xu·∫•t</label>
                                <select class="form-select" id="carYear" required>
                                    <option value="">-- Ch·ªçn nƒÉm --</option>
                                    <script>
                                        const yearNow = new Date().getFullYear();
                                        for (let y = yearNow; y >= 1990; y--) {
                                            document.write(`<option value="${y}">${y}</option>`);
                                        }
                                    </script>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">S·ªë km hi·ªán t·∫°i</label>
                                <input type="number" class="form-control" id="currentKm" placeholder="V√≠ d·ª•: 45250">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">M√†u xe</label>
                                <select class="form-select" id="carColor">
                                    <option value="">-- Ch·ªçn m√†u --</option>
                                    <option value="Tr·∫Øng">Tr·∫Øng</option>
                                    <option value="ƒêen">ƒêen</option>
                                    <option value="X√°m">X√°m</option>
                                    <option value="ƒê·ªè">ƒê·ªè</option>
                                    <option value="Xanh">Xanh</option>
                                    <option value="B·∫°c">B·∫°c</option>
                                </select>
                            </div>


                            <div class="col-md-3">
                                <label class="form-label">Lo·∫°i nhi√™n li·ªáu</label>
                                <select class="form-select" id="fuelType">
                                    <option value="">-- Ch·ªçn lo·∫°i --</option>
                                    <option value="XƒÉng">XƒÉng</option>
                                    <option value="D·∫ßu">D·∫ßu</option>
                                    <option value="ƒêi·ªán">ƒêi·ªán</option>
                                    <option value="Hybrid">Hybrid</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label for="carCondition" class="form-label">T√¨nh tr·∫°ng xe khi nh·∫≠n</label>
                                <select id="carCondition" class="form-select">
                                    <option value="">-- Ch·ªçn t√¨nh tr·∫°ng --</option>
                                    <option value="normal">B√¨nh th∆∞·ªùng</option>
                                    <option value="minor-scratch">Tr·∫ßy nh·∫π</option>
                                    <option value="damaged">H∆∞ h·ªèng</option>
                                    <option value="dirty">B·∫©n / C·∫ßn v·ªá sinh</option>
                                    <option value="other">Kh√°c...</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Lo·∫°i s·ª≠ d·ª•ng</label>
                                <select class="form-select" id="usageType">
                                    <option value="PERSONAL">C√° nh√¢n</option>
                                    <option value="SERVICE">D·ªãch v·ª•</option>
                                    <option value="TAXI">Taxi</option>
                                    <option value="RENTAL">Cho thu√™</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Ng√†y nh·∫≠n xe</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="receivedDate">
                                    <button class="btn btn-outline-secondary" type="button" id="btnSetNow">B√¢y gi·ªù</button>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">K·ªπ thu·∫≠t vi√™n ti·∫øp nh·∫≠n</label>
                                <input type="text" class="form-control" id="receiverTech" readonly placeholder="(t·ª± ƒë·ªông)">
                                <input type="hidden" id="receiverTechId" name="receiverTechId">
                            </div>

                            <!-- ========== D·ªäCH V·ª§ Y√äU C·∫¶U + GHI CH√ö ========== -->
                            <div class="col-12 mt-4">
                                <div class="row">
                                    <div class="col-lg-8 col-md-7">
                                        <h6 class="section-title"><i class="fas fa-wrench me-2"></i>D·ªãch v·ª• y√™u c·∫ßu</h6>
                                        <div class="mb-3 position-relative">
                                            <input type="text" id="serviceSearch" class="form-control" placeholder="Nh·∫≠p t√™n d·ªãch v·ª•...">
                                            <ul id="serviceSuggestions"
                                                class="list-group position-absolute w-100 shadow"
                                                style="z-index:1000; display:none;"></ul>
                                        </div>
                                        <div id="selectedServiceList" class="mt-3"></div>
                                        <input type="hidden" id="selectedServicesJson" name="selectedServicesJson">
                                    </div>

                                    <div class="col-lg-4 col-md-5 mt-4 mt-md-0">
                                        <h6 class="section-title"><i class="fas fa-clipboard-list me-2"></i>Ghi ch√∫ th√™m</h6>
                                        <textarea class="form-control" id="notes" rows="5" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-light border me-2" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="submit" class="btn btn-primary px-4"><i class="fas fa-check me-2"></i>T·∫°o phi·∫øu</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- üî• INJECT D·ªÆ LI·ªÜU T·ª™ THYMELEAF V√ÄO JAVASCRIPT -->
<script th:inline="javascript">
    // ===========================
    // üöÄ NH·∫¨N D·ªÆ LI·ªÜU T·ª™ CONTROLLER
    // ===========================
    const BACKEND_TICKETS = /*[[${tickets}]]*/ [];

    console.log('‚úÖ D·ªØ li·ªáu t·ª´ Backend:', BACKEND_TICKETS);
    console.log('‚úÖ T·ªïng s·ªë phi·∫øu:', BACKEND_TICKETS.length);
</script>

<script>
    // ===========================
    // GLOBAL VARIABLES
    // ===========================
    let serviceOrders = [];
    let filteredOrders = [];
    let currentPage = 1;
    const limit = 5;

    const mechanics = [
        { id: 1, name: 'Nguy·ªÖn VƒÉn Th·ª£', tickets: 2, status: 'busy' },
        { id: 2, name: 'Tr·∫ßn C√¥ng S·ª≠a', tickets: 1, status: 'busy' },
        { id: 3, name: 'L√™ K·ªπ Thu·∫≠t', tickets: 0, status: 'available' },
        { id: 4, name: 'Ph·∫°m VƒÉn Chuy√™n', tickets: 3, status: 'busy' },
        { id: 5, name: 'Ho√†ng Thanh Long', tickets: 0, status: 'available' }
    ];

    // ===========================
    // üî• KH·ªûI T·∫†O D·ªÆ LI·ªÜU
    // ===========================
    function initializeData() {
        console.log('üîÑ Kh·ªüi t·∫°o d·ªØ li·ªáu t·ª´ Backend...');

        if (!BACKEND_TICKETS || BACKEND_TICKETS.length === 0) {
            console.warn('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ Backend');
            showEmptyState();
            return;
        }

        // Map d·ªØ li·ªáu t·ª´ Backend sang format Frontend
        serviceOrders = BACKEND_TICKETS.map(ticket => ({
            code: ticket.ticketCode?.replace('#', '') || '',
            customer: ticket.customerName || 'N/A',
            phone: ticket.customerPhone || 'N/A',
            plate: ticket.licensePlate || 'N/A',
            service: ticket.serviceName || 'N/A',
            createdAt: ticket.createdAt || new Date().toISOString(),
            mechanic: mapMechanicData(ticket),
            status: mapStatus(ticket.status)
        }));

        filteredOrders = [...serviceOrders];

        console.log('‚úÖ ƒê√£ map ƒë∆∞·ª£c:', serviceOrders.length, 'phi·∫øu');

        // Render d·ªØ li·ªáu
        renderTable();
        updateStatistics();
    }

    // ===========================
    // MAP D·ªÆ LI·ªÜU MECHANIC
    // ===========================
    function mapMechanicData(ticket) {
        if (!ticket.mechanicName || ticket.mechanicName === '‚Äî') {
            return null;
        }

        return {
            id: ticket.mechanicId || null,
            name: ticket.mechanicName,
            status: (ticket.mechanicStatus === 'ENGAGED' || ticket.mechanicStatus === 'ƒêang l√†m')
                ? 'busy'
                : 'available',
            tickets: 0
        };
    }

    // ===========================
    // MAP TR·∫†NG TH√ÅI
    // ===========================
    function mapStatus(status) {
        const statusMap = {
            'PENDING': 'New',
            'APPROVED': 'Assigned',
            'IN_PROGRESS': 'In Progress',
            'COMPLETED': 'Completed',
            'INVOICED': 'Invoiced',
            'PAID': 'Paid',
            'CANCELLED': 'Cancelled'
        };
        return statusMap[status] || 'New';
    }

    // ===========================
    // RENDER B·∫¢NG
    // ===========================
    function renderTable() {
        const tbody = document.getElementById('serviceTableBody');
        const start = (currentPage - 1) * limit;
        const end = start + limit;
        const visible = filteredOrders.slice(start, end);

        if (visible.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Kh√¥ng c√≥ phi·∫øu d·ªãch v·ª• n√†o</p>
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = visible.map(order => `
            <tr class="fade-in">
                <td><strong style="color: var(--primary);">#${order.code}</strong></td>
                <td>
                    <div style="font-weight: 600; color: var(--dark);">${order.customer}</div>
                    <div style="font-size: 12px; color: #6c757d;">${order.phone}</div>
                </td>
                <td><span style="font-weight: 600; color: var(--info);">${order.plate}</span></td>
                <td>${order.service}</td>
                <td>${renderMechanic(order.mechanic)}</td>
                <td>${renderStatus(order.status)}</td>
                <td class="text-center">${renderActions(order)}</td>
            </tr>
        `).join('');

        renderPagination();

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng phi·∫øu
        document.getElementById('totalTickets').textContent = filteredOrders.length;
    }

    // ===========================
    // RENDER MECHANIC
    // ===========================
    function renderMechanic(mechanic) {
        if (!mechanic) {
            return '<span style="color: #adb5bd; font-size: 13px;">Ch∆∞a ph√¢n c√¥ng</span>';
        }

        const statusIcon = mechanic.status === 'available' ? 'üü¢' : 'üü†';
        const statusText = mechanic.status === 'available' ? 'R·∫£nh' : 'ƒêang l√†m';

        return `
            <div class="mechanic-info">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(mechanic.name)}&background=FF7A00&color=fff"
                     class="mechanic-avatar" alt="${mechanic.name}">
                <div>
                    <div class="mechanic-name">${mechanic.name}</div>
                    <div class="mechanic-status">${statusIcon} ${statusText}</div>
                </div>
            </div>`;
    }

    // ===========================
    // RENDER STATUS
    // ===========================
    function renderStatus(status) {
        const statusMap = {
            'New': { class: 'new', icon: 'fa-file', text: 'M·ªõi' },
            'Assigned': { class: 'assigned', icon: 'fa-user-check', text: 'ƒê√£ ph√¢n c√¥ng' },
            'In Progress': { class: 'in-progress', icon: 'fa-cog fa-spin', text: 'ƒêang x·ª≠ l√Ω' },
            'Completed': { class: 'completed', icon: 'fa-check-circle', text: 'Ho√†n t·∫•t' },
            'Invoiced': { class: 'invoiced', icon: 'fa-file-invoice', text: 'ƒê√£ t·∫°o h√≥a ƒë∆°n' },
            'Paid': { class: 'paid', icon: 'fa-check-double', text: 'ƒê√£ thanh to√°n' },
            'Cancelled': { class: 'cancelled', icon: 'fa-times-circle', text: 'ƒê√£ h·ªßy' }
        };

        const s = statusMap[status] || statusMap['New'];
        return `<span class="status-badge ${s.class}"><i class="fas ${s.icon}"></i> ${s.text}</span>`;
    }

    // ===========================
    // RENDER ACTIONS
    // ===========================
    function renderActions(order) {
        const now = new Date();
        const created = new Date(order.createdAt);
        const diffMinutes = (now - created) / 60000;
        const canCancel = order.status === 'Pending Confirmation' && diffMinutes >= 5;

        // Base button lu√¥n hi·ªÉn th·ªã
        let actions = `
            <div class="d-flex justify-content-center flex-wrap gap-2">
                <button class="action-btn view" onclick="viewTicket('${order.code}')">
                    <i class="fas fa-eye"></i>
                </button>`;

        // =============================
        // 1Ô∏è‚É£ Staff t·∫°o phi·∫øu (New)
        // =============================
        if (order.status === 'New') {
            actions += `
                <button class="action-btn edit" onclick="editTicket('${order.code}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn assign" onclick="openAssignModal('${order.code}')">
                    <i class="fas fa-user-plus"></i> Ph√¢n c√¥ng
                </button>`;
        }

            // =============================
            // 2Ô∏è‚É£ Staff ƒë√£ ph√¢n c√¥ng mechanic
        // =============================
        else if (order.status === 'Assigned') {
            actions += `
                <button class="action-btn disabled" title="ƒêang ch·ªù th·ª£ nh·∫≠n vi·ªác">
                    <i class="fas fa-hourglass-half"></i> Ch·ªù nh·∫≠n vi·ªác
                </button>`;
        }

            // =============================
            // 3Ô∏è‚É£ Mechanic x√°c nh·∫≠n nh·∫≠n vi·ªác (In Progress)
        // =============================
        else if (order.status === 'In Progress') {
            actions += `
                <button class="action-btn add-service" onclick="openAddServiceRequest('${order.code}')">
                    <i class="fas fa-plus-circle"></i> B·ªï sung
                </button>
                <button class="action-btn complete" onclick="openCompleteModal('${order.code}')">
                    <i class="fas fa-check-circle"></i> Ho√†n th√†nh
                </button>`;
        }

            // =============================
            // 4Ô∏è‚É£ Phi·∫øu ho√†n t·∫•t
        // =============================
        else if (order.status === 'Completed') {
            actions += `
                <button class="action-btn invoice" onclick="createInvoice('${order.code}')" id="btn-invoice-${order.code}">
                    <i class="fas fa-file-invoice"></i> T·∫°o h√≥a ƒë∆°n
                </button>`;
        }

            // =============================
            // 5Ô∏è‚É£ H√≥a ƒë∆°n ƒë√£ t·∫°o
        // =============================
        else if (order.status === 'Invoiced') {
            actions += `
                <button class="action-btn disabled">
                    <i class="fas fa-file-invoice-dollar"></i> Ch·ªù thanh to√°n
                </button>`;
        }

            // =============================
            // 6Ô∏è‚É£ ƒê√£ thanh to√°n
        // =============================
        else if (order.status === 'Paid') {
            actions += `<button class="action-btn disabled">ƒê√£ thanh to√°n</button>`;
        }

            // =============================
            // ‚ùå Phi·∫øu h·ªßy
        // =============================
        else if (order.status === 'Cancelled') {
            actions += `<button class="action-btn disabled">ƒê√£ h·ªßy</button>`;
        }

            // =============================
            // ‚è≥ Ch·ªù kh√°ch x√°c nh·∫≠n email
        // =============================
        else if (order.status === 'Pending Confirmation') {
            if (canCancel) {
                actions += `
                    <button class="action-btn cancel" onclick="cancelTicket('${order.code}')">
                        <i class="fas fa-times"></i> H·ªßy phi·∫øu
                    </button>`;
            } else {
                actions += `
                    <button class="action-btn disabled" title="Ch·ªù kh√°ch x√°c nh·∫≠n">
                        <i class="fas fa-clock"></i> ƒêang ch·ªù x√°c nh·∫≠n
                    </button>`;
            }
        }

        actions += `</div>`;
        return actions;
    }

    // ===========================
    // PAGINATION
    // ===========================
    function renderPagination() {
        const totalPages = Math.ceil(filteredOrders.length / limit);
        const pagination = document.getElementById('pagination');

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <button class="page-link" onclick="gotoPage(${i})">${i}</button>
                </li>`;
        }

        pagination.innerHTML = html;
    }

    function gotoPage(page) {
        currentPage = page;
        renderTable();
        document.getElementById('serviceCard')?.scrollIntoView({ behavior: 'smooth' });
    }

    // ===========================
    // SEARCH & FILTER
    // ===========================
    function searchTickets() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;

        filteredOrders = serviceOrders.filter(order => {
            const matchSearch = !query ||
                order.code.toLowerCase().includes(query) ||
                order.customer.toLowerCase().includes(query) ||
                order.plate.toLowerCase().includes(query);

            const matchStatus = !status || order.status === status;

            return matchSearch && matchStatus;
        });

        currentPage = 1;
        renderTable();
    }

    function filterByStatus() {
        searchTickets();
    }

    // ===========================
    // UPDATE STATISTICS
    // ===========================
    function updateStatistics() {
        const pending = serviceOrders.filter(o => o.status === 'New' || o.status === 'Assigned').length;
        const completed = serviceOrders.filter(o => o.status === 'Completed').length;

        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('pendingChange').textContent = '+' + Math.floor(pending / 4);
        document.getElementById('completedChange').textContent = '+' + Math.floor(completed / 3);
    }

    // ===========================
    // EMPTY STATE
    // ===========================
    function showEmptyState() {
        const tbody = document.getElementById('serviceTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Ch∆∞a c√≥ phi·∫øu d·ªãch v·ª• n√†o</p>
                    <button class="btn btn-primary" onclick="openCreateTicket()">
                        <i class="fas fa-plus"></i> T·∫°o phi·∫øu m·ªõi
                    </button>
                </td>
            </tr>`;
    }

    // ===========================
    // ACTION FUNCTIONS
    // ===========================
    function viewTicket(code) {
        showToast('info', 'Xem chi ti·∫øt', `ƒêang t·∫£i th√¥ng tin phi·∫øu #${code}`);
        // TODO: Implement view ticket detail modal
    }

    function editTicket(code) {
        showToast('info', 'Ch·ªânh s·ª≠a', `M·ªü form ch·ªânh s·ª≠a phi·∫øu #${code}`);
        // TODO: Implement edit ticket
    }

    function openAddServiceRequest(code) {
        showToast('info', 'B·ªï sung d·ªãch v·ª•', `Y√™u c·∫ßu b·ªï sung d·ªãch v·ª• cho phi·∫øu #${code}`);
        // TODO: Implement add service request
        const modal = new bootstrap.Modal(document.getElementById('addServiceRequestModal'));
        document.getElementById('amendTicketId').value = code;
        modal.show();
    }

    function submitAddServiceRequest(event) {
        event.preventDefault();
        const ticketId = document.getElementById('amendTicketId').value;
        const service = document.getElementById('amendServiceSelect').value;
        const reason = document.getElementById('amendReason').value;

        showToast('success', 'G·ª≠i y√™u c·∫ßu th√†nh c√¥ng', `ƒê√£ g·ª≠i y√™u c·∫ßu b·ªï sung d·ªãch v·ª• cho phi·∫øu #${ticketId}`);
        bootstrap.Modal.getInstance(document.getElementById('addServiceRequestModal')).hide();
    }

    function cancelTicket(code) {
        Swal.fire({
            title: 'X√°c nh·∫≠n h·ªßy phi·∫øu',
            text: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy phi·∫øu #${code}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'H·ªßy phi·∫øu',
            cancelButtonText: 'Kh√¥ng'
        }).then((result) => {
            if (result.isConfirmed) {
                const order = serviceOrders.find(o => o.code === code);
                if (order) {
                    order.status = 'Cancelled';
                    renderTable();
                    showToast('success', 'ƒê√£ h·ªßy', `Phi·∫øu #${code} ƒë√£ ƒë∆∞·ª£c h·ªßy`);
                }
            }
        });
    }

    function openAssignModal(code) {
        const modal = new bootstrap.Modal(document.getElementById('assignModal'));
        document.getElementById('assignTicketCode').textContent = `#${code}`;
        modal.show();
        showToast('info', 'Ph√¢n c√¥ng', `Ch·ªçn th·ª£ cho phi·∫øu #${code}`);
    }

    function openCompleteModal(code) {
        const modal = new bootstrap.Modal(document.getElementById('confirmCompleteModal'));
        document.getElementById('completeTicketCode').textContent = `#${code}`;
        modal.show();
    }

    function confirmComplete() {
        const code = document.getElementById('completeTicketCode').textContent.replace('#', '');
        const order = serviceOrders.find(o => o.code === code);

        if (order) {
            order.status = 'Completed';
            renderTable();
            showToast('success', 'Ho√†n th√†nh!', `Phi·∫øu #${code} ƒë√£ ho√†n t·∫•t s·ª≠a ch·ªØa üéâ`);
            bootstrap.Modal.getInstance(document.getElementById('confirmCompleteModal')).hide();
        }
    }

    function createInvoice(code) {
        Swal.fire({
            title: 'T·∫°o h√≥a ƒë∆°n',
            text: `T·∫°o h√≥a ƒë∆°n cho phi·∫øu #${code}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'T·∫°o h√≥a ƒë∆°n',
            cancelButtonText: 'H·ªßy'
        }).then((result) => {
            if (result.isConfirmed) {
                const order = serviceOrders.find(o => o.code === code);
                if (order) {
                    order.status = 'Invoiced';
                    renderTable();
                    showToast('success', 'T·∫°o h√≥a ƒë∆°n th√†nh c√¥ng', `ƒê√£ t·∫°o h√≥a ƒë∆°n cho phi·∫øu #${code}`);
                }
            }
        });
    }

    function openCreateTicket() {
        const modal = new bootstrap.Modal(document.getElementById('createTicketModal'));
        modal.show();
        document.getElementById('createTicketForm').reset();
    }

    function handleCreateTicket(event) {
        event.preventDefault();
        showToast('success', 'T·∫°o phi·∫øu th√†nh c√¥ng', 'Phi·∫øu d·ªãch v·ª• m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o');
        bootstrap.Modal.getInstance(document.getElementById('createTicketModal')).hide();
        // TODO: Implement actual ticket creation
    }

    // ===========================
    // TOAST NOTIFICATION
    // ===========================
    function showToast(type, title, message) {
        const container = document.getElementById('toastContainer');
        const id = Date.now();

        const iconMap = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'info': 'info-circle',
            'warning': 'exclamation-triangle'
        };

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = `toast-${id}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas fa-${iconMap[type]}"></i>
            </div>
            <div class="toast-content">
                <p class="toast-title">${title}</p>
                <p class="toast-message">${message}</p>
            </div>`;

        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideIn 0.4s reverse';
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    // ===========================
    // LOGOUT
    // ===========================
    async function logout(event) {
        event.preventDefault();
        const result = await Swal.fire({
            title: 'X√°c nh·∫≠n ƒëƒÉng xu·∫•t',
            text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ff7e29',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ƒêƒÉng xu·∫•t',
            cancelButtonText: 'H·ªßy'
        });

        if (result.isConfirmed) {
            window.location.href = '/auth/logout';
        }
    }

    // ===========================
    // üöÄ KH·ªûI ƒê·ªòNG KHI PAGE LOAD
    // ===========================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Dashboard Staff ƒë√£ load');
        initializeData();
    });
</script>
</body>
</html>