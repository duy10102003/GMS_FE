<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GaragePro - Dashboard Nh√¢n vi√™n</title>

    <!-- Bootstrap & Icons -->
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css}"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/staff/staff-dashboard.css}"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
<!-- Sidebar -->
<aside class="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <span class="orange">Garage</span><span class="dark">Pro</span>
        </div>
    </div>

    <div class="user-profile" th:with="staffName=${staffName ?: 'Nh√¢n vi√™n'}, staffId=${staffId ?: 0}">
        <img th:src="@{'https://ui-avatars.com/api/?name=' + ${staffName ?: 'Nh√¢n vi√™n'} + '&background=FF7A00&color=fff'}"
             alt="Avatar">
        <div class="user-info">
            <h6 th:text="${staffName}">Tr·∫ßn Th·ªã B</h6>
            <small>Nh√¢n vi√™n l·ªÖ t√¢n</small>
            <small class="text-light" th:text="'ID: ' + ${staffId}">ID: 0</small>
        </div>
    </div>

    <ul class="nav-menu">
        <li><a href="/dashboard-staff.html" class="nav-link active"><i class="fas fa-gauge"></i> Dashboard</a></li>
        <li><a href="/payment" class="nav-link"><i class="fas fa-credit-card"></i> Thanh to√°n</a></li>
        <li><a href="/inventory-alert" class="nav-link"><i class="fas fa-exclamation-triangle"></i> C·∫£nh b√°o kho</a></li>
    </ul>

    <button class="logout-btn" type="button" onclick="logout(event)">
        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
    </button>
</aside>

<!-- Header -->
<header class="main-header d-flex align-items-center justify-content-between">
    <h1 class="page-title">Dashboard Nh√¢n vi√™n üìã</h1>

    <div class="dropdown position-relative">
        <button class="notification-btn" id="notifDropdown" data-bs-toggle="dropdown">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">4</span>
        </button>

        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-0" style="min-width: 320px; border-radius: 16px;">
            <li class="dropdown-header py-3 px-3 border-bottom bg-light fw-semibold">
                Th√¥ng b√°o h√¥m nay
            </li>
            <li><a href="#" class="dropdown-item py-3">
                <div class="d-flex align-items-start gap-3">
                    <div style="width:40px;height:40px;background:rgba(247,183,49,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#f7b731;">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div>
                        <strong>Phi·∫øu m·ªõi #SV009</strong>
                        <div class="small text-muted">Kh√°ch h√†ng: L√™ VƒÉn C</div>
                        <div class="small text-muted">V·ª´a xong</div>
                    </div>
                </div>
            </a></li>
            <li><a href="#" class="dropdown-item py-3">
                <div class="d-flex align-items-start gap-3">
                    <div style="width:40px;height:40px;background:rgba(16,172,132,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#10ac84;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <strong>Ho√†n t·∫•t thanh to√°n</strong>
                        <div class="small text-muted">Phi·∫øu #SV007</div>
                        <div class="small text-muted">10 ph√∫t tr∆∞·ªõc</div>
                    </div>
                </div>
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a href="#" class="dropdown-item text-center text-primary fw-semibold py-3">Xem t·∫•t c·∫£</a></li>
        </ul>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="d-flex justify-content-end align-items-center mb-3">
        <nav class="breadcrumb mb-0">
            <span><a href="#" class="text-primary text-decoration-none">Staff</a></span>
            <span class="mx-2 text-muted">/</span>
            <span class="text-muted">T·ªïng quan</span>
        </nav>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid fade-in">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(84, 160, 255, 0.1); color: var(--info);">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <h6>Phi·∫øu ch·ªù x·ª≠ l√Ω</h6>
            <div class="value">8</div>
            <div class="change negative"><i class="fas fa-arrow-up"></i> +2 h√¥m nay</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(16, 172, 132, 0.1); color: var(--success);">
                <i class="fas fa-check-circle"></i>
            </div>
            <h6>Ho√†n th√†nh h√¥m nay</h6>
            <div class="value">12</div>
            <div class="change positive"><i class="fas fa-arrow-up"></i> +4 so v·ªõi h√¥m qua</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(247, 183, 49, 0.1); color: var(--warning);">
                <i class="fas fa-box"></i>
            </div>
            <h6>C·∫£nh b√°o ph·ª• t√πng</h6>
            <div class="value">3</div>
            <div class="change negative"><i class="fas fa-exclamation-triangle"></i> C·∫ßn nh·∫≠p kho</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(255, 122, 0, 0.1); color: var(--primary);">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <h6>Doanh thu h√¥m nay</h6>
            <div class="value">15.8M</div>
            <div class="change positive"><i class="fas fa-chart-line"></i> +12%</div>
        </div>
    </div>

    <!-- Service Management Card -->
    <div class="content-card fade-in" id="serviceCard">
        <div class="content-card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
            <h5><i class="fas fa-clipboard-list me-2"></i>Qu·∫£n l√Ω phi·∫øu d·ªãch v·ª•</h5>
            <button class="btn btn-primary" onclick="openCreateTicket()">
                <i class="fas fa-plus"></i> T·∫°o phi·∫øu m·ªõi
            </button>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="T√¨m theo m√£ phi·∫øu, kh√°ch h√†ng, bi·ªÉn s·ªë..." id="searchInput" oninput="searchTickets()">
            </div>
            <div class="dropdown d-inline-block">
                <button class="btn btn-outline-secondary dropdown-toggle px-4 py-2" type="button" id="statusFilterBtn" data-bs-toggle="dropdown">
                    <i class="fas fa-filter me-2"></i>T·∫•t c·∫£ tr·∫°ng th√°i
                </button>
                <ul class="dropdown-menu shadow-lg border-0 p-2" style="min-width: 220px;">
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('')">
                        <i class="fas fa-circle text-secondary me-2" style="font-size:8px;"></i> T·∫•t c·∫£ tr·∫°ng th√°i
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('New')">
                        <span class="status-badge new me-2"><i class="fas fa-file"></i></span> M·ªõi
                    </a></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('Approved')">
                        <span class="status-badge approved me-2"><i class="fas fa-check"></i></span> ƒê√£ duy·ªát
                    </a></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('Assigned')">
                        <span class="status-badge assigned me-2"><i class="fas fa-user-check"></i></span> ƒê√£ ph√¢n c√¥ng
                    </a></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('In Progress')">
                        <span class="status-badge in-progress me-2"><i class="fas fa-cog fa-spin"></i></span> ƒêang x·ª≠ l√Ω
                    </a></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('Completed')">
                        <span class="status-badge completed me-2"><i class="fas fa-check-circle"></i></span> Ho√†n t·∫•t
                    </a></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('Invoiced')">
                        <span class="status-badge invoiced me-2"><i class="fas fa-file-invoice"></i></span> ƒê√£ t·∫°o h√≥a ƒë∆°n
                    </a></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('Paid')">
                        <span class="status-badge paid me-2"><i class="fas fa-check-double"></i></span> ƒê√£ thanh to√°n
                    </a></li>
                    <li><a class="dropdown-item py-2 px-3 rounded" href="#" onclick="filterStatus('Cancelled')">
                        <span class="status-badge cancelled me-2"><i class="fas fa-times-circle"></i></span> ƒê√£ h·ªßy
                    </a></li>
                </ul>
            </div>
        </div>

        <!-- Table -->
        <div style="overflow-x: auto;">
            <table class="custom-table">
                <thead>
                <tr>
                    <th>M√£ phi·∫øu</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>Bi·ªÉn s·ªë</th>
                    <th>D·ªãch v·ª•</th>
                    <th>Th·ª£ ph·ª• tr√°ch</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                    <th>Ph·ª• tr·ª£</th>
                </tr>
                </thead>
                <tbody id="serviceTableBody"></tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav>
            <ul class="pagination" id="pagination"></ul>
        </nav>
    </div>
</main>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Modal: Create Ticket -->
<div class="modal fade" id="createTicketModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content p-4 shadow-lg border-0 rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">
                    <i class="fas fa-file-medical me-2 text-primary"></i>
                    T·∫°o phi·∫øu d·ªãch v·ª• m·ªõi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body mt-2">
                <form id="createTicketForm" onsubmit="handleCreateTicket(event)">
                    <div class="row g-3">

                        <!-- ========== TH√îNG TIN KH√ÅCH H√ÄNG ========== -->
                        <div class="col-12">
                            <h6 class="section-title"><i class="fas fa-user me-2"></i>Th√¥ng tin kh√°ch h√†ng</h6>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">H·ªç t√™n *</label>
                            <input type="text" class="form-control" id="customerName" required placeholder="Nguy·ªÖn VƒÉn A">
                        </div>

                        <!--                        <div class="col-md-4">-->
                        <!--                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>-->
                        <!--                            <input type="tel" class="form-control" id="customerPhone" required placeholder="0912345678">-->
                        <!--                        </div>-->

                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="customerEmail" placeholder="example@email.com">
                        </div>

                        <!-- ========== TH√îNG TIN XE ========== -->
                        <div class="col-12 mt-4">
                            <h6 class="section-title"><i class="fas fa-car me-2"></i>Th√¥ng tin xe</h6>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Bi·ªÉn s·ªë *</label>
                            <!-- ƒê√£ c√≥ trong form -->
                            <input type="text" class="form-control" id="plateNumber" required placeholder="30H-12345" onblur="fetchVehicleInfo(this.value)">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">H√£ng xe (Brand)</label>
                            <select class="form-select" id="carBrand" required>
                                <option value="">-- Ch·ªçn h√£ng --</option>
                                <option value="Toyota">Toyota</option>
                                <option value="Mazda">Mazda</option>
                                <option value="Hyundai">Hyundai</option>
                                <option value="Honda">Honda</option>
                                <option value="Kia">Kia</option>
                                <option value="VinFast">VinFast</option>
                                <option value="Mitsubishi">Mitsubishi</option>
                                <option value="Ford">Ford</option>
                            </select>
                        </div>

                        <div class="col-md-3 position-relative">
                            <label class="form-label">Model xe</label>
                            <input type="text" class="form-control" id="carModelInput" placeholder="Nh·∫≠p model xe..." autocomplete="off" required>
                            <ul id="modelSuggestions"
                                class="list-group position-absolute w-100 shadow"
                                style="z-index:1000; display:none; max-height:180px; overflow-y:auto;"></ul>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">NƒÉm s·∫£n xu·∫•t</label>
                            <select class="form-select" id="carYear" required>
                                <option value="">-- Ch·ªçn nƒÉm --</option>
                                <script>
                                    const yearNow = new Date().getFullYear();
                                    for (let y = yearNow; y >= 1990; y--) {
                                        document.write(`<option value="${y}">${y}</option>`);
                                    }
                                </script>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">S·ªë km hi·ªán t·∫°i</label>
                            <input type="number" class="form-control" id="currentKm" placeholder="V√≠ d·ª•: 45250">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">M√†u xe</label>
                            <select class="form-select" id="carColor">
                                <option value="">-- Ch·ªçn m√†u --</option>
                                <option value="Tr·∫Øng">Tr·∫Øng</option>
                                <option value="ƒêen">ƒêen</option>
                                <option value="X√°m">X√°m</option>
                                <option value="ƒê·ªè">ƒê·ªè</option>
                                <option value="Xanh">Xanh</option>
                                <option value="B·∫°c">B·∫°c</option>
                            </select>
                        </div>


                        <div class="col-md-3">
                            <label class="form-label">Lo·∫°i nhi√™n li·ªáu</label>
                            <select class="form-select" id="fuelType">
                                <option value="">-- Ch·ªçn lo·∫°i --</option>
                                <option value="XƒÉng">XƒÉng</option>
                                <option value="D·∫ßu">D·∫ßu</option>
                                <option value="ƒêi·ªán">ƒêi·ªán</option>
                                <option value="Hybrid">Hybrid</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="carCondition" class="form-label">T√¨nh tr·∫°ng xe khi nh·∫≠n</label>
                            <select id="carCondition" class="form-select">
                                <option value="">-- Ch·ªçn t√¨nh tr·∫°ng --</option>
                                <option value="normal">B√¨nh th∆∞·ªùng</option>
                                <option value="minor-scratch">Tr·∫ßy nh·∫π</option>
                                <option value="damaged">H∆∞ h·ªèng</option>
                                <option value="dirty">B·∫©n / C·∫ßn v·ªá sinh</option>
                                <option value="other">Kh√°c...</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Lo·∫°i s·ª≠ d·ª•ng</label>
                            <select class="form-select" id="usageType">
                                <option value="PERSONAL">C√° nh√¢n</option>
                                <option value="SERVICE">D·ªãch v·ª•</option>
                                <option value="TAXI">Taxi</option>
                                <option value="RENTAL">Cho thu√™</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Ng√†y nh·∫≠n xe</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="receivedDate">
                                <button class="btn btn-outline-secondary" type="button" id="btnSetNow">B√¢y gi·ªù</button>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">K·ªπ thu·∫≠t vi√™n ti·∫øp nh·∫≠n</label>
                            <input type="text" class="form-control" id="receiverTech" readonly placeholder="(t·ª± ƒë·ªông)">
                            <input type="hidden" id="receiverTechId" name="receiverTechId">
                        </div>

                        <!-- ========== D·ªäCH V·ª§ Y√äU C·∫¶U + GHI CH√ö ========== -->
                        <div class="col-12 mt-4">
                            <div class="row">
                                <div class="col-lg-8 col-md-7">
                                    <h6 class="section-title"><i class="fas fa-wrench me-2"></i>D·ªãch v·ª• y√™u c·∫ßu</h6>
                                    <div class="mb-3 position-relative">
                                        <input type="text" id="serviceSearch" class="form-control" placeholder="Nh·∫≠p t√™n d·ªãch v·ª•...">
                                        <ul id="serviceSuggestions"
                                            class="list-group position-absolute w-100 shadow"
                                            style="z-index:1000; display:none;"></ul>
                                    </div>
                                    <div id="selectedServiceList" class="mt-3"></div>
                                    <input type="hidden" id="selectedServicesJson" name="selectedServicesJson">
                                </div>

                                <div class="col-lg-4 col-md-5 mt-4 mt-md-0">
                                    <h6 class="section-title"><i class="fas fa-clipboard-list me-2"></i>Ghi ch√∫ th√™m</h6>
                                    <textarea class="form-control" id="notes" rows="5" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-light border me-2" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-primary px-4"><i class="fas fa-check me-2"></i>T·∫°o phi·∫øu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: View Ticket Detail -->
<div class="modal fade" id="viewTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="fas fa-eye me-2 text-primary"></i>Chi ti·∫øt phi·∫øu d·ªãch v·ª•</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ticketDetailContent">
                <!-- N·ªôi dung chi ti·∫øt render b·∫±ng JS -->
            </div>
        </div>
    </div>
</div>

<!-- Modal: Assign Mechanic -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-cog me-2"></i>Ph√¢n c√¥ng th·ª£ s·ª≠a</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p class="text-muted mb-4">
                    Ch·ªçn th·ª£ ph·ª• tr√°ch phi·∫øu <strong id="assignTicketCode"></strong>
                </p>

                <!-- ‚úÖ Grid th·ª£ s·ª≠a -->
                <div class="mechanic-grid" id="mechanicGrid"></div>

                <!-- ‚úÖ Ph√¢n trang th·ª£ -->
                <div class="mechanic-pagination" id="mechanicPagination"></div>

                <!-- ‚úÖ N√∫t h√†nh ƒë·ªông -->
                <div class="text-end mt-4">
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary"
                            style="background:#e76f00;border:none;"
                            onclick="confirmAssignment()"
                            id="confirmAssignBtn"
                            disabled>
                        <i class="fas fa-check me-2"></i>X√°c nh·∫≠n ph√¢n c√¥ng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Y√™u c·∫ßu b·ªï sung d·ªãch v·ª• -->
<div class="modal fade" id="addServiceRequestModal" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4 p-3">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">
                    <i class="fas fa-plus-circle text-primary me-2"></i>Y√™u c·∫ßu b·ªï sung d·ªãch v·ª•
                </h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body mt-2">
                <form id="addServiceRequestForm" onsubmit="submitAddServiceRequest(event)">
                    <input type="hidden" id="amendTicketId">
                    <div class="mb-3">
                        <label class="form-label">D·ªãch v·ª• mu·ªën th√™m *</label>
                        <select id="amendServiceSelect" class="form-select" required>
                            <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">L√Ω do ƒë·ªÅ xu·∫•t</label>
                        <textarea id="amendReason" class="form-control" rows="3" placeholder="V√≠ d·ª•: Kh√°ch mu·ªën thay d·∫ßu th√™m..."></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-light border me-2" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>G·ª≠i y√™u c·∫ßu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirm Complete -->
<div class="modal fade" id="confirmCompleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="confirm-dialog">
                    <div class="confirm-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h5 class="confirm-title">X√°c nh·∫≠n ho√†n th√†nh</h5>
                    <p class="confirm-message">B·∫°n ch·∫Øc ch·∫Øn phi·∫øu <strong id="completeTicketCode"></strong> ƒë√£ ho√†n t·∫•t s·ª≠a ch·ªØa?</p>
                    <div class="confirm-actions">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-primary" onclick="confirmComplete()">
                            <i class="fas fa-check me-2"></i>X√°c nh·∫≠n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // ===========================
    // D·ªÆ LI·ªÜU T·ª™ BACKEND (THYMELEAF)
    // ===========================
    const BACKEND_TICKETS = /*[[${tickets}]]*/ [];
    console.log('D·ªØ li·ªáu t·ª´ Backend:', BACKEND_TICKETS);

    // ===========================
    // D·ªÆ LI·ªÜU M·∫™U (n·∫øu backend r·ªóng)
    // ===========================
    const mechanics = [
        { id: 1, name: 'Nguy·ªÖn VƒÉn Th·ª£', tickets: 0, status: 'available' },
        { id: 2, name: 'Tr·∫ßn C√¥ng S·ª≠a', tickets: 0, status: 'available' },
        { id: 3, name: 'L√™ K·ªπ Thu·∫≠t', tickets: 0, status: 'available' },
        { id: 4, name: 'Ph·∫°m VƒÉn Chuy√™n', tickets: 0, status: 'available' },
        { id: 5, name: 'Ho√†ng Thanh Long', tickets: 0, status: 'available' },
        { id: 6, name: 'ƒê·ªó Minh Tu·∫•n', tickets: 0, status: 'available' },
        { id: 7, name: 'Nguy·ªÖn ƒê·ª©c C∆°', tickets: 0, status: 'available' },
        { id: 8, name: 'Tr·∫ßn H·ªØu H√†o', tickets: 0, status: 'available' },
        { id: 9, name: 'L∆∞u Quang Minh', tickets: 0, status: 'available' }
    ];

    // ===========================
    // BI·∫æN TO√ÄN C·ª§C
    // ===========================
    let serviceOrders = [];
    let filteredOrders = [];
    let currentPage = 1;
    const limit = 5;
    let selectedOrder = null;
    let selectedMechanic = null;
    let mechanicPage = 1;
    const perPage = 6;

    let assignModalInstance = null;
    let completeModalInstance = null;
    let createTicketModalInstance = null;
    let viewTicketModalInstance = null;
    let addServiceRequestModalInstance = null;

    // ===========================
    // KH·ªûI T·∫†O D·ªÆ LI·ªÜU
    // ===========================
    function initializeData() {
        if (!BACKEND_TICKETS || BACKEND_TICKETS.length === 0) {
            console.warn('Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ backend');
            showEmptyState();
            return;
        }

        serviceOrders = BACKEND_TICKETS.map(ticket => {
            const mechanic = ticket.mechanicId ? mechanics.find(m => m.id === ticket.mechanicId) : null;
            if (mechanic) {
                mechanic.tickets = (mechanic.tickets || 0) + 1;
                mechanic.status = 'busy';
            }

            return {
                code: ticket.ticketCode?.replace('#', '') || 'N/A',
                customer: ticket.customerName || 'Kh√°ch l·∫ª',
                phone: ticket.customerPhone || 'N/A',
                plate: ticket.licensePlate || 'N/A',
                service: ticket.serviceName || 'B·∫£o d∆∞·ª°ng',
                mechanic: mechanic,
                status: mapStatus(ticket.status),
                createdAt: ticket.createdAt
            };
        });

        filteredOrders = [...serviceOrders];
        renderTable();
        updateStatistics();
    }

    function mapStatus(status) {
        const map = {
            'PENDING': 'New',
            'APPROVED': 'Approved',
            'ASSIGNED': 'Assigned',
            'IN_PROGRESS': 'In Progress',
            'COMPLETED': 'Completed',
            'INVOICED': 'Invoiced',
            'PAID': 'Paid',
            'CANCELLED': 'Cancelled'
        };
        return map[status] || 'New';
    }

    // ===========================
    // RENDER B·∫¢NG
    // ===========================
    function renderTable() {
        const tbody = document.getElementById('serviceTableBody');
        const start = (currentPage - 1) * limit;
        const end = start + limit;
        const visible = filteredOrders.slice(start, end);

        if (visible.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">Kh√¥ng c√≥ phi·∫øu n√†o</td></tr>`;
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        tbody.innerHTML = visible.map(order => `
            <tr class="fade-in">
                <td><strong style="color: var(--primary);">#${order.code}</strong></td>
                <td>
                    <div style="font-weight: 600; color: var(--dark);">${order.customer}</div>
                    <div style="font-size: 12px; color: #6c757d;">${order.phone}</div>
                </td>
                <td><span style="font-weight: 600; color: var(--info);">${order.plate}</span></td>
                <td>${order.service}</td>
                <td>${renderMechanic(order.mechanic)}</td>
                <td>${renderStatus(order.status)}</td>
                <td>${renderActions(order)}</td>
                <td>${renderAuxiliary(order)}</td>
            </tr>
        `).join('');

        renderPagination();
    }

    function renderMechanic(mechanic) {
        if (!mechanic) return '<span style="color: #adb5bd; font-size: 13px;">Ch∆∞a ph√¢n c√¥ng</span>';
        const statusIcon = mechanic.status === 'available' ? 'R·∫£nh' : 'ƒêang l√†m';
        return `
            <div class="mechanic-info">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(mechanic.name)}&background=FF7A00&color=fff" class="mechanic-avatar" alt="${mechanic.name}">
                <div>
                    <div class="mechanic-name">${mechanic.name}</div>
                    <div class="mechanic-status">${statusIcon} ${mechanic.tickets} phi·∫øu</div>
                </div>
            </div>`;
    }

    function renderStatus(status) {
        const map = {
            'New':       { class: 'new',       icon: 'fa-file',           text: 'M·ªõi' },
            'Approved':  { class: 'approved',  icon: 'fa-check',          text: 'ƒê√£ duy·ªát' },
            'Assigned':  { class: 'assigned',  icon: 'fa-user-check',     text: 'ƒê√£ ph√¢n c√¥ng' },
            'In Progress': { class: 'in-progress', icon: 'fa-cog fa-spin', text: 'ƒêang x·ª≠ l√Ω' },
            'Completed': { class: 'completed', icon: 'fa-check-circle',   text: 'Ho√†n t·∫•t' },
            'Invoiced':  { class: 'invoiced',  icon: 'fa-file-invoice',   text: 'ƒê√£ t·∫°o h√≥a ƒë∆°n' },
            'Paid':      { class: 'paid',      icon: 'fa-check-double',   text: 'ƒê√£ thanh to√°n' },
            'Cancelled': { class: 'cancelled', icon: 'fa-times-circle',   text: 'ƒê√£ h·ªßy' }
        };
        const s = map[status] || map['New'];
        return `<span class="status-badge ${s.class}"><i class="fas ${s.icon}"></i> ${s.text}</span>`;
    }

    function renderActions(order) {
        if (order.status === 'New' || order.status === 'Approved') {
            return `<button class="action-btn assign" onclick="openAssignModal('${order.code}')">
                    <i class="fas fa-user-plus"></i> Ph√¢n c√¥ng
                </button>`;
        }
        else if (order.status === 'Assigned') {
            return `<button class="action-btn start" onclick="startWork('${order.code}')">
                    <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu l√†m
                </button>`;
        }
        else if (order.status === 'In Progress') {
            return `<button class="action-btn complete" onclick="openCompleteModal('${order.code}')">
                    <i class="fas fa-check-circle"></i> Ho√†n th√†nh
                </button>`;
        }
        else if (order.status === 'Completed') {
            return `<button class="action-btn invoice" onclick="createInvoice('${order.code}')">
                    <i class="fas fa-file-invoice"></i> T·∫°o h√≥a ƒë∆°n
                </button>`;
        }
        else if (order.status === 'Invoiced') {
            return `<button class="action-btn" disabled>Ch·ªù thanh to√°n</button>`;
        }
        else {
            return `<button class="action-btn" disabled>${order.status === 'Paid' ? 'ƒê√£ xong' : 'ƒê√£ h·ªßy'}</button>`;
        }
    }

    function renderAuxiliary(order) {
        return `
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary"
                    onclick="openViewTicketModal('${order.code}')"
                    title="Xem chi ti·∫øt">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-success"
                    onclick="openAddPartModal('${order.code}')"
                    title="B·ªï sung ph·ª• t√πng">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    `;
    }
    // ===========================
    // PH√ÇN TRANG
    // ===========================
    function renderPagination() {
        const totalPages = Math.ceil(filteredOrders.length / limit);
        const pagination = document.getElementById('pagination');
        if (totalPages <= 1) { pagination.innerHTML = ''; return; }

        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><button class="page-link" onclick="gotoPage(${i})">${i}</button></li>`;
        }
        pagination.innerHTML = html;
    }

    function gotoPage(page) {
        currentPage = page;
        renderTable();
        document.getElementById('serviceCard')?.scrollIntoView({ behavior: 'smooth' });
    }

    // ===========================
    // T√åM KI·∫æM & L·ªåC
    // ===========================
    function searchTickets() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;

        filteredOrders = serviceOrders.filter(order => {
            const matchSearch = !query ||
                order.code.toLowerCase().includes(query) ||
                order.customer.toLowerCase().includes(query) ||
                order.plate.toLowerCase().includes(query);
            const matchStatus = !status || order.status === status;
            return matchSearch && matchStatus;
        });

        currentPage = 1;
        renderTable();
    }

    function filterByStatus() { searchTickets(); }

    // ===========================
    // MODAL PH√ÇN C√îNG
    // ===========================
    function openAssignModal(code) {
        selectedOrder = code;
        selectedMechanic = null;
        mechanicPage = 1;
        document.getElementById('assignTicketCode').textContent = `#${code}`;
        document.getElementById('confirmAssignBtn').disabled = true;
        renderMechanicGrid();

        const modalEl = document.getElementById('assignModal');
        if (!assignModalInstance) assignModalInstance = new bootstrap.Modal(modalEl);
        assignModalInstance.show();
    }

    function renderMechanicGrid() {
        const grid = document.getElementById('mechanicGrid');
        const start = (mechanicPage - 1) * perPage;
        const visible = mechanics.slice(start, start + perPage);
        const slots = [...visible];
        while (slots.length < perPage) slots.push({ placeholder: true });

        grid.innerHTML = slots.map(m => {
            if (m.placeholder) {
                return `<div class="mechanic-card placeholder" style="opacity:0.4;background:#f8f9fa;"><div style="text-align:center;padding:40px 0;color:#adb5bd;">(Tr·ªëng)</div></div>`;
            }

            const statusClass = m.status === 'available' ? 'available' : 'busy';
            const statusIcon = m.status === 'available' ? 'R·∫£nh' : 'ƒêang l√†m';

            return `
            <div class="mechanic-card" id="mechanic-${m.id}" onclick="selectMechanic(${m.id})">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(m.name)}&background=e76f00&color=fff" class="mechanic-card-avatar" alt="${m.name}">
                <div class="mechanic-card-name">${m.name}</div>
                <div class="mechanic-card-tickets">${m.tickets} phi·∫øu</div>
                <span class="mechanic-card-status ${statusClass}">${statusIcon}</span>
            </div>`;
        }).join('');

        renderMechanicPagination();
    }

    function renderMechanicPagination() {
        const totalPages = Math.ceil(mechanics.length / perPage);
        const pagination = document.getElementById('mechanicPagination');
        if (totalPages <= 1) { pagination.innerHTML = ''; return; }

        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            const active = i === mechanicPage ? 'background:#e76f00;color:#fff;border:1px solid #e76f00;' : 'background:#fff;color:#333;border:1px solid #dee2e6;';
            html += `<button onclick="gotoMechanicPage(${i})" style="width:36px;height:36px;border-radius:8px;margin:0 4px;font-weight:600;${active}">${i}</button>`;
        }
        pagination.innerHTML = html;
    }

    function startWork(code) {
        const order = serviceOrders.find(o => o.code === code);
        if (!order || !order.mechanic) return;

        order.status = 'In Progress';
        renderTable();
        showToast('info', 'B·∫Øt ƒë·∫ßu l√†m', `Th·ª£ ${order.mechanic.name} ƒë√£ nh·∫≠n phi·∫øu #${code}`);
    }

    function gotoMechanicPage(page) {
        mechanicPage = page;
        selectedMechanic = null;
        document.getElementById('confirmAssignBtn').disabled = true;
        renderMechanicGrid();
    }

    function selectMechanic(id) {
        selectedMechanic = id;
        document.querySelectorAll('.mechanic-card').forEach(c => c.classList.remove('selected'));
        document.getElementById(`mechanic-${id}`)?.classList.add('selected');
        document.getElementById('confirmAssignBtn').disabled = false;
    }

    function confirmAssignment() {
        if (!selectedMechanic) return;
        const order = serviceOrders.find(o => o.code === selectedOrder);
        const mechanic = mechanics.find(m => m.id === selectedMechanic);
        if (!order || !mechanic) return;

        order.mechanic = mechanic;
        order.status = 'Assigned';
        mechanic.tickets++;
        mechanic.status = 'busy';

        assignModalInstance.hide();
        setTimeout(() => {
            renderTable();
            showToast('success', 'Ph√¢n c√¥ng th√†nh c√¥ng!', `ƒê√£ giao #${selectedOrder} cho ${mechanic.name}`);
        }, 200);
    }

    // ===========================
    // HO√ÄN TH√ÄNH & T·∫†O H√ìA ƒê∆†N
    // ===========================
    function openCompleteModal(code) {
        selectedOrder = code;
        document.getElementById('completeTicketCode').textContent = `#${code}`;
        const modalEl = document.getElementById('confirmCompleteModal');
        if (!completeModalInstance) completeModalInstance = new bootstrap.Modal(modalEl);
        completeModalInstance.show();
    }

    function confirmComplete() {
        const order = serviceOrders.find(o => o.code === selectedOrder);
        if (!order) return;
        order.status = 'Completed';
        if (order.mechanic) {
            order.mechanic.tickets = Math.max(0, order.mechanic.tickets - 1);
            if (order.mechanic.tickets === 0) order.mechanic.status = 'available';
        }
        completeModalInstance.hide();
        setTimeout(() => { renderTable(); showToast('success', 'Ho√†n t·∫•t!', `#${selectedOrder} ƒë√£ xong!`); }, 200);
    }

    function createInvoice(code) {
        const order = serviceOrders.find(o => o.code === code);
        if (!order || order.status !== 'Completed') return;
        order.status = 'Invoiced';
        renderTable();
        showToast('success', 'T·∫°o h√≥a ƒë∆°n!', `Phi·∫øu #${code} ƒë√£ c√≥ h√≥a ƒë∆°n`);
    }

    // ===========================
    // T·∫†O PHI·∫æU M·ªöI
    // ===========================
    function openCreateTicket() {
        const modalEl = document.getElementById('createTicketModal');
        if (!createTicketModalInstance) createTicketModalInstance = new bootstrap.Modal(modalEl);
        createTicketModalInstance.show();
        document.getElementById('createTicketForm').reset();
    }

    function handleCreateTicket(e) {
        e.preventDefault();
        const name = document.getElementById('customerName').value;
        const plate = document.getElementById('plateNumber').value;
        if (!name || !plate) return showToast('error', 'L·ªói', 'Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');

        const newCode = `SV${String((serviceOrders[0]?.code?.replace('SV', '') || 0) * 1 + 1).padStart(3, '0')}`;
        const newOrder = { code: newCode, customer: name, phone: 'N/A', plate, service: 'B·∫£o d∆∞·ª°ng', mechanic: null, status: 'New' };
        serviceOrders.unshift(newOrder);
        filteredOrders = [...serviceOrders];
        createTicketModalInstance.hide();
        setTimeout(() => { currentPage = 1; renderTable(); showToast('success', 'T·∫°o phi·∫øu!', `#${newCode} ƒë√£ ƒë∆∞·ª£c t·∫°o`); }, 200);
    }

    // ===========================
    // TOAST
    // ===========================
    function showToast(type, title, message) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<div class="toast-icon"><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i></div><div class="toast-content"><p class="toast-title">${title}</p><p class="toast-message">${message}</p></div>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'slideIn 0.4s reverse'; setTimeout(() => toast.remove(), 400); }, 3000);
    }

    function showEmptyState() {
        document.getElementById('serviceTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">Ch∆∞a c√≥ phi·∫øu d·ªãch v·ª•</td></tr>`;
    }

    function updateStatistics() {
        const pending = serviceOrders.filter(o => ['New', 'Assigned'].includes(o.status)).length;
        const completed = serviceOrders.filter(o => o.status === 'Completed').length;
        document.querySelectorAll('.stat-card .value')[0].textContent = pending;
        document.querySelectorAll('.stat-card .value')[1].textContent = completed;
    }
    // ===========================
    // Open view ticket
    // ===========================
    function openViewTicketModal(code) {
        const order = serviceOrders.find(o => o.code === code);
        if (!order) return;

        const modalBody = document.getElementById('ticketDetailContent');
        modalBody.innerHTML = `
        <div class="p-3">
            <p><strong>M√£ phi·∫øu:</strong> #${order.code}</p>
            <p><strong>Kh√°ch h√†ng:</strong> ${order.customer} (${order.phone})</p>
            <p><strong>Bi·ªÉn s·ªë:</strong> ${order.plate}</p>
            <p><strong>D·ªãch v·ª•:</strong> ${order.service}</p>
            <p><strong>Th·ª£ ph·ª• tr√°ch:</strong> ${order.mechanic ? order.mechanic.name : 'Ch∆∞a ph√¢n c√¥ng'}</p>
            <p><strong>Tr·∫°ng th√°i:</strong> ${renderStatus(order.status)}</p>
            <hr>
            <p class="text-muted small">T·∫°o l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
        </div>
    `;

        const modalEl = document.getElementById('viewTicketModal');
        if (!viewTicketModalInstance) viewTicketModalInstance = new bootstrap.Modal(modalEl);
        viewTicketModalInstance.show();
    }
    // ===========================
    // Open add service
    // ===========================
    function openAddServiceRequestModal(code) {
        selectedOrder = code;
        document.getElementById('amendTicketId').value = code;
        document.getElementById('addServiceRequestForm').reset();

        // T√πy ch·ªçn: ƒê·∫∑t ti√™u ƒë·ªÅ modal
        const modalTitle = document.querySelector('#addServiceRequestModal .modal-title');
        if (modalTitle) {
            modalTitle.innerHTML = `<i class="fas fa-plus-circle text-success me-2"></i>B·ªï sung d·ªãch v·ª• ‚Äì Phi·∫øu #${code}`;
        }

        const modalEl = document.getElementById('addServiceRequestModal');
        if (!addServiceRequestModalInstance) addServiceRequestModalInstance = new bootstrap.Modal(modalEl);
        addServiceRequestModalInstance.show();
    }
    // ===========================
    // KH·ªûI ƒê·ªòNG
    // ===========================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Dashboard Staff kh·ªüi ƒë·ªông...');
        initializeData();
    });
</script>

<!-- Script logout -->
<script th:inline="javascript">
    const LOGOUT_URL = /*[[@{/auth/logout}]]*/ '/auth/logout';
    const HOME_URL = /*[[@{/}]]*/ '/';

    async function logout(event) {
        event.preventDefault();

        const result = await Swal.fire({
            title: 'X√°c nh·∫≠n ƒëƒÉng xu·∫•t',
            text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ff7e29',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ƒêƒÉng xu·∫•t',
            cancelButtonText: 'H·ªßy'
        });

        if (!result.isConfirmed) return;

        Swal.fire({
            title: 'ƒêang ƒëƒÉng xu·∫•t...',
            text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const response = await fetch(LOGOUT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            Swal.close();

            if (response.ok) { // Lu√¥n OK n·∫øu logic invalidate session th√†nh c√¥ng
                await Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: data.message,
                    timer: 1500,
                    showConfirmButton: false
                });

                // ‚úÖ Redirect v·ªÅ trang home
                window.location.href = HOME_URL;
            } else {
                // X·ª≠ l√Ω l·ªói t·ª´ server (INTERNAL_SERVER_ERROR)
                await Swal.fire({
                    icon: 'error',
                    title: 'ƒêƒÉng xu·∫•t th·∫•t b·∫°i!',
                    text: data.message || 'M√°y ch·ªß kh√¥ng ph·∫£n h·ªìi. Vui l√≤ng th·ª≠ l·∫°i.'
                });
            }
        } catch (e) {
            console.error('Logout error:', e);
            Swal.close();
            await Swal.fire({
                icon: 'error',
                title: 'L·ªói h·ªá th·ªëng!',
                text: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.'
            });
        }
    }
</script>
</body>
</html>